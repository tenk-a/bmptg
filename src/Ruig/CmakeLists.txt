cmake_minimum_required(VERSION 3.18)

project(ruig)

set(ROOT_DIR       "${CMAKE_SOURCE_DIR}/../..")
set(THIRDPARTY_DIR "${ROOT_DIR}/thirdparty")
set(SRC_DIR        "${CMAKE_SOURCE_DIR}/..")
set(PNG_DIR        "${THIRDPARTY_DIR}/libpng")
set(ZLIB_DIR       "${THIRDPARTY_DIR}/zlib")

set(LIBJPEG_TURBO_INSTALL_DIR "${CMAKE_BINARY_DIR}/libjpeg-turbo-install")
set(JPEG_LIB ${LIBJPEG_TURBO_INSTALL_DIR}/lib/libturbojpeg.a)

set(RUIG_SRCS
    ${SRC_DIR}/Ruig/Ruig.cpp
    ${SRC_DIR}/Ruig/RuigMgr.cpp
    ${SRC_DIR}/Ruig/RuigMgr.hpp
    ${SRC_DIR}/Ruig/stdafx.h
    ${SRC_DIR}/Ruig/targetver.h
    ${SRC_DIR}/Ruig/ExArgv_conf.h
)

set(IMGFMT_SRCS
    ${SRC_DIR}/ImgFmt/JpgEncoder.hpp
    ${SRC_DIR}/ImgFmt/JpgEncoder.cpp
    ${SRC_DIR}/ImgFmt/JpgDecoder.hpp
    ${SRC_DIR}/ImgFmt/JpgDecoder.cpp
)

set(PROC_SRCS
    ${SRC_DIR}/Proc/BppCnvImg.hpp
    ${SRC_DIR}/Proc/DecreaseColorHst.hpp
    ${SRC_DIR}/Proc/DecreaseColorIfWithin256.hpp
    ${SRC_DIR}/Proc/DecreaseColorMC.hpp
    ${SRC_DIR}/Proc/FixedClut256.hpp
    ${SRC_DIR}/Proc/PaternDither.hpp
    ${SRC_DIR}/Proc/pix32_bokashi.h
    ${SRC_DIR}/Proc/pix32_colCnv.h
    ${SRC_DIR}/Proc/pix32_filter.h
    ${SRC_DIR}/Proc/pix32_paint.hpp
    ${SRC_DIR}/Proc/pix32_resize.h
    ${SRC_DIR}/Proc/pix_subr.h
)

set(MISC_SRCS
    ${SRC_DIR}/misc/def.h
    ${SRC_DIR}/misc/subr.h
    ${SRC_DIR}/misc/subr.c
    ${SRC_DIR}/misc/StrExpr.c
    ${SRC_DIR}/misc/intrusive_ptr.hpp
    ${SRC_DIR}/misc/intrusive_ptr_ref_count.hpp
    ${SRC_DIR}/misc/File.hpp
    ${SRC_DIR}/misc/fks_file_time.c
    ${SRC_DIR}/misc/fks_file_time.h
    ${SRC_DIR}/misc/mem_mac.h
    ${SRC_DIR}/misc/misc.hpp
    ${SRC_DIR}/misc/ExArgv.c
    ${SRC_DIR}/misc/ExArgv.h
)

# set(CMAKE_CXX_STANDARD 11)
# set(CMAKE_CXX_STANDARD_REQUIRED ON)

add_compile_options(-DUSE_JPG -DUSE_PNG)

if(WIN32)
  set(ADD_SRCS "${THIRDPARTY_DIR}/ms/ActiveCodePageUTF8.manifest")
  add_compile_options(-D_ANSI)

  if(MSVC)
    set(JPEG_LIB ${LIBJPEG_TURBO_INSTALL_DIR}/lib/turbojpeg-static.lib)
    # set(ADD_LIBS kernel32.lib user32.lib gdi32.lib winspool.lib shell32.lib ole32.lib oleaut32.lib uuid.lib comdlg32.lib advapi32.lib)
    set(ADD_LIBS kernel32.lib user32.lib shell32.lib advapi32.lib)

    set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${PROJECT_NAME})
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")

    add_compile_options(-Zc:wchar_t -Zc:forScope)

    if(CMAKE_C_COMPILER_VERSION VERSION_GREATER_EQUAL "19.0.24215.1")
      add_compile_options(-utf-8)
    endif()
    if(CMAKE_CXX_COMPILER_VERSION VERSION_GREATER_EQUAL "19.0.24215.1")
      add_compile_options(-utf-8 -Zc:rvalueCast)
    endif()
    if(CMAKE_CXX_COMPILER_VERSION VERSION_GREATER_EQUAL "19.14.26428.1")
      add_compile_options(-Zc:__cplusplus)
    endif()
    if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS "19.0")
      if(NOT EXISTS "${THIRDPARTY_DIR}/ccwrap")
        message(FATAL_ERROR "thirdparty/ccwrap directory is missing. For vc12 and earlier, run thirdparty/install_ccwap.bat")
      endif()
      set(ADD_INC_DIRS "${THIRDPARTY_DIR}/ccwrap/vc/" "${THIRDPARTY_DIR}/ccwrap/ccwrap/")
      add_compile_options(-FI${THIRDPARTY_DIR}/ccwrap/vc/ccwrap_header.h)
      add_compile_options(-D_UNICODE)
    endif()
  else()
    # g++
    add_compile_options(-finput-charset=utf-8 -fexec-charset=utf-8 -fwide-exec-charset=utf-32LE)
  endif()
  #if(CMAKE_C_COMPILER_ID MATCHES "Watcom" OR CMAKE_CXX_COMPILER_ID MATCHES "Watcom")
  #  # message(STATUS "Using Watcom C/C++ Compiler!!!")
  #endif()
else()
  if(APPLE)
    #add_compile_options(--std=c++20)
  else()
    add_compile_options(-finput-charset=utf-8 -fexec-charset=utf-8 -fwide-exec-charset=utf-32LE)
  endif()
endif()

include(ExternalProject)


ExternalProject_Add(
    libjpeg-turbo
    SOURCE_DIR "${THIRDPARTY_DIR}/libjpeg-turbo"
    BINARY_DIR "${CMAKE_BINARY_DIR}/libjpeg-turbo-build"
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${LIBJPEG_TURBO_INSTALL_DIR}
#    BUILD_COMMAND "${CMAKE_COMMAND}" --build <BINARY_DIR> --target turbojpeg-static
    INSTALL_COMMAND "${CMAKE_COMMAND}" --build <BINARY_DIR> --target install --config $<CONFIG>
    STEP_TARGETS build
    EXCLUDE_FROM_ALL TRUE
)

#set_target_properties(${PROJECT_NAME} PROPERTIES
#  RUNTIME_OUTPUT_DIRECTORY ${ROOT_DIR}/bin
#)

add_executable(${PROJECT_NAME}
    ${RUIG_SRCS}
    ${IMGFMT_SRCS}
    ${PROC_SRCS}
    ${MISC_SRCS}
    ${ADD_SRCS}
)

add_dependencies(${PROJECT_NAME} libjpeg-turbo)

target_include_directories(${PROJECT_NAME} PRIVATE
    ${ADD_INC_DIRS}
    ${SRC_DIR}/bmptg
    ${SRC_DIR}/ImgFmt
    ${SRC_DIR}/Proc
    ${SRC_DIR}/misc
    ${LIBJPEG_TURBO_INSTALL_DIR}/include
    ${THIRDPARTY_DIR}
    ${THIRDPARTY_DIR}/libjpeg-turbo
)

target_link_libraries(${PROJECT_NAME} PRIVATE
    ${JPEG_LIB}
    ${ADD_LIBS}
)
